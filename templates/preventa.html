{% extends "base.html" %}
{% block title %}Inicio{% endblock %}
{% block content %}

<div class="container-fluid" style="position: absolute;">
  <div class="container">
    <div class="content">

      <!-- Sección de búsqueda -->
      <div class="search-section">
        <form class="search-form" method="POST" action="/buscar_cliente">
          <input type="text" name="codigo_cliente" class="search-input" placeholder="Ingrese Código Cliente (ej: CLI001)"
                 value="{{ request.form.get('codigo_cliente','') }}">
          <button type="submit" class="btn btn-primary">Buscar Cliente</button>
        </form>
      </div>

      {% if clientes_ejemplo %}
      <div style="margin-top:20px; font-size:0.9em; color:#6c757d;">
        <strong>Clientes de ejemplo:</strong> CLI001, CLI002, CLI003
      </div>
      {% endif %}

      <div class="loading" id="loading" style="display:none;">
        <div class="spinner"></div>
        <p>Buscando clientes...</p>
      </div>

      {% if error %}
      <div class="alert alert-danger"><strong>Error:</strong> {{ error }}</div>
      {% endif %}

      {% if success %}
      <div class="alert alert-success"><strong>Éxito:</strong> {{ success }}</div>
      {% endif %}

      {% if codigo %}
      <div class="pedido-info">
        <h5 class="text-center">Pedido No. {{ codigo.codigo }}</h5>

        <table border="1" class="table table-striped mt-3">
          <thead>
            <tr>
              <th>Cliente:</th><th>{{ codigo.cliente }}</th>
            </tr>
            <tr>
              <th>Teléfono:</th><th>{{ codigo.telefono }}</th>
            </tr>
            <tr>
              <th>Fecha:</th><th>{{ codigo.fecha }}</th>
            </tr>
            <tr>
              <th>Dirección:</th><th>{{ codigo.direccion }}</th>
            </tr>
          </thead>
        </table>

        <div class="form-section mt-4">
          <form method="POST" action="/grabar_pedido" id="pedidoForm">
            <input type="hidden" name="numero_pedido" value="{{ codigo.numero }}">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>#</th><th>Artículo</th><th>Cantidad</th><th>Precio Unitario</th><th>Subtotal</th>
                </tr>
              </thead>
              <tbody>
                {% for articulo in codigo.articulos %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td><input type="text" name="nombre_{{ articulo.id }}" class="form-control" value="{{ articulo.nombre }}"></td>
                  <td><input type="number" name="cantidad_{{ articulo.id }}" class="form-control"
                             value="{{ articulo.cantidad }}" min="1" required onchange="calcularSubtotal({{ articulo.id }})"></td>
                  <td><input type="number" name="precio_{{ articulo.id }}" class="form-control"
                             value="{{ articulo.precio }}" step="0.01" min="0" required onchange="calcularSubtotal({{ articulo.id }})"></td>
                  <td><span id="subtotal_{{ articulo.id }}" class="subtotal">{{ '%.2f'|format(articulo.cantidad * articulo.precio) }}</span></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            <div class="total-section mt-3">
              <strong>Total del Pedido: <span id="total">${{ '%.2f'|format(total) }}</span></strong>
            </div>

            <div class="form-actions mt-4">
              <button type="submit" class="btn btn-success">Grabar Pedido</button>
              <a href="/" class="btn btn-danger">Cancelar</a>
            </div>
          </form>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  document.querySelector('form').addEventListener('submit', () => {
    document.getElementById('loading').style.display = 'block';
  });

  function calcularSubtotal(id) {
    const cantidad = document.querySelector(input[name='cantidad_${id}']).value;
    const precio = document.querySelector(input[name='precio_${id}']).value;
    const subtotal = cantidad * precio;
    document.getElementById(subtotal_${id}).textContent = $${subtotal.toFixed(2)};
    calcularTotal();
  }

  function calcularTotal() {
    let total = 0;
    document.querySelectorAll('.subtotal').forEach(el => {
      total += parseFloat(el.textContent.replace('$', '')) || 0;
    });
    document.getElementById('total').textContent = $${total.toFixed(2)};
  }
</script>
{% endblock %}